# WebSocket connections

A WebSocket request and response are part of the WebSocket handshake process, which starts with an HTTP/1.1 upgrade request and response. Below is a detailed example showing the headers and status codes exchanged during the handshake:

## WebSocket request

The client sends an HTTP/1.1 request to upgrade the connection to WebSocket:

```http
GET /chat HTTP/1.1
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
```

- Upgrade: websocket
  - Indicates the request is attempting to upgrade to WebSocket.
- Connection: Upgrade
  - Indicates the upgrade is required for this connection.
- Sec-WebSocket-Key
  - A base64-encoded random value that the server will use to generate a response key.
- Sec-WebSocket-Version
  - Specifies the WebSocket protocol version being used (typically 13)

## WebSocket response

If the server accepts the upgrade, it responds with a status code 101 Switching Protocols and includes required headers:

```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```

- 101 Switching Protocols
  - Indicates the server has agreed to switch to the WebSocket protocol.
- Sec-WebSocket-Accept
  - A base64-encoded string, generated by concatenating the Sec-WebSocket-Key from the client with a specific GUID (258EAFA5-E914-47DA-95CA-C5AB0DC85B11) and hashing it using SHA-1, then base64 encoding the result.
- Upgrade and Connection
  - Reiterate that the connection is being upgraded.

## WebSocket data frames

Once the handshake is complete, the WebSocket connection transitions from HTTP to a full-duplex protocol. After the handshake, the connection operates using WebSocket frames, not HTTP. The data is exchanged as binary frames. Here's an example:

### Client frame (request)

```plaintext
0x81 0x85 0x37 0xfa 0x21 0x3d 0x7f 0x9f 0x4d 0x51 0x58
```

- 0x81
  - Denotes a text frame (opcode 1).
- Payload
  - Masked text payload sent by the client.

### Server frame (response)

```plaintext
0x81 0x05 0x48 0x65 0x6c 0x6c 0x6f
```

- 0x81
  - Text frame (opcode 1).
- Payload
  - Unmasked text payload: Hello.

## How does the request / response look like if we already have a WebSocket connection established?

Once a WebSocket connection is established, communication happens using WebSocket frames rather than traditional HTTP requests and responses. These frames are exchanged directly over the persistent connection, enabling real-time, full-duplex communication between the client and the server.

Hereâ€™s how the requests and responses look when using an established WebSocket connection:

### WebSocket Frame Format

Each WebSocket frame consists of specific components:

- FIN and Opcode
  - Control whether the message is complete and its type (e.g., text or binary).
- Mask
  - Indicates if the data is masked (client messages must be masked).
- Payload Length
  - Specifies the size of the data.
- Payload
  - Contains the actual message or data.

### Example of Frames

#### 1. Client Sends a Message (Text Frame):
- The client sends a simple text message, e.g., "Hello, Server!"

Frame Breakdown:

- FIN = 1 (indicates the message is complete in one frame).
- Opcode = 1 (text message).
- Mask = 1 (clients must mask messages).
- Payload: "Hello, Server!"

Frame in bytes:
```plaintext
81 8D <4-byte masking key> <masked payload data>
```

- 81: FIN (1) + Opcode (1 for text).
- 8D: Mask (1) + Payload length (13 bytes).
- 4-byte masking key: Used to unmask the payload.
- "masked payload": "Hello, Server!" after masking.

<br/>
<br/>

#### 2. Server Responds (Text Frame):
- The server replies with "Hello, Client!"

Frame Breakdown:

- FIN = 1.
- Opcode = 1 (text message).
- Mask = 0 (servers do not mask data).
- Payload: "Hello, Client!"

Frame in bytes:
```plaintext
81 0D <unmasked payload data>
```

- 81: FIN (1) + Opcode (1 for text).
- 0D: Mask (0) + Payload length (13 bytes).
- "unmasked payload": "Hello, Client!"

<br/>
<br/>

#### 3. Client Sends a Ping Frame:
- Ping frames are used to check the connection's health.

Frame Breakdown:

- FIN = 1.
- Opcode = 9 (ping).
- Mask = 1 (clients mask).
- Payload: Optional (e.g., "Ping").

Frame in bytes:
```plaintext
89 <payload length + masking key> <masked payload>
```

<br/>
<br/>

#### 4. Server Responds with a Pong Frame:
- The server replies with a Pong frame in response to the Ping.

Frame Breakdown:

- FIN = 1.
- Opcode = 10 (pong).
- Mask = 0 (servers do not mask data).
- Payload: Matches the Ping payload.

Frame in bytes:
```plaintext
8A <payload length> <payload>
```

## WebSocket communication example

### Client Request

Client sends a JSON message over the WebSocket connection:

```json
{
  "type": "message",
  "content": "How are you?"
}
```

- WebSocket Frame
  - Encoded as a binary frame with the appropriate opcode (1 for text).

### Server Response

Server replies with a JSON response:

```json
{
  "type": "reply",
  "content": "I am fine, thank you!"
}
```

- WebSocket Frame
  - Similar frame structure with the response payload.

## Advantages of WebSocket frames

- Compact
  - Minimal overhead compared to HTTP headers.
- Efficient
  - Full-duplex, low-latency communication.
- Flexible
  - Handles both text and binary data seamlessly.

